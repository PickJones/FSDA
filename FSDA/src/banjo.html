<!DOCTYPE html>
<html>
<head>
<script src="jquery-3.1.1.js"></script>
<script src="jquery-csv.js"></script>
<script>
  var playerArray = [[]];
  var players = [{}];
  var cntr = {};
  $('#output').hide();
  $(function() {
    $('#srchbox').keyup(function() { doSearch($('#srchbox').val()); });
    $('#rankcsv').bind('change', prepareDA);
  });
  function prepareDA(f) {
    $('#output').append('prepareDA()<br>');
    
    //load file into array
    fileToArray(f);

    //array to object
    setTimeout(function() {
      arrayToObject();
    },1000);

    //inspect arry
    //inspectArray();

    //prepare html tables
    setTimeout(function() {
      prepareTables();
    },2000);

    //show all the players
    setTimeout(function() {
      displayPlayers();
    },3000);
  }
  function fileToArray(f) {
    $('#output').append('fileToArray()<br>');
    var files = f.target.files;
    var file = files[0];
    var reader = new FileReader();
    reader.readAsText(file);
    reader.onload = function(event) {
      var csv = event.target.result;
      playerArray = $.csv.toArrays(csv);
    };
    reader.onerror = function() { alert('Unable to read ' + file.fileName); };
    $('#output').append('END fileToArray()<br>');
  }
  function arrayToObject() {
    $('#output').append('arrayToObject()<br>');
    for (var row in playerArray) {
      if ($.isNumeric(playerArray[row][3]) && playerArray[row][3] !== "undefined") {
        players.push({ 
          status:"Available"
         ,name:playerArray[row][0]
         ,team:playerArray[row][1]
         ,rank:parseInt(playerArray[row][3])
         ,position:playerArray[row][2]
         ,posrk:playerArray[row][2]+playerArray[row][3]
         ,rkpos:("00"+playerArray[row][3]).slice(-3) + playerArray[row][2]
         ,posrkz:playerArray[row][2]+("00"+playerArray[row][3]).slice(-3)
        });
        if (!cntr[playerArray[row][2]]) {
          cntr[playerArray[row][2]] = {Available:0, Mine:0, Taken:0};
        }
      }
    }
    players.shift();
    players.sort(function(a,b) {
      return ((a.rkpos < b.rkpos) ? -1 : ((a.rkpos > b.rkpos) ? 1 : 0));
    });
    $('#output').append('playerArray.length=' + playerArray.length + '<br>');
    $('#output').append('players.length=' + players.length + '<br>');
    for (var p in cntr) {
      $('#output').append(p + '|');
    }
    $('#output').append('<br>');
    $('#fileStats').append('Imported ' + (players.length) + ' player(s)');
    $('#output').append('END arrayToObject()<br>');
  }
  function prepareTables() {
    $('#output').append('prepareTables()<br>');
    var th = '<tr>';
    for (var p in cntr) {
      th += '<td align="center"><b>' + p + '</b></td>';
    }
    th += '</tr>'
    $('#tMine thead').append(th);
    $('#tAvailable thead').append(th);
    $('#tTaken thead').append(th);
    var tb = '<tr>';
    for (var p in cntr) {
      tb += '<td valign="top"><table id="tSTATUS' + p + '"><tbody></tbody></table></td>';
    }
    tb += '</tr>'
    //alert(tb.replace(/STATUS/g, 'Mine'));
    $('#tMine tbody').append(tb.replace(/STATUS/g, 'Mine'));
    $('#tAvailable tbody').append(tb.replace(/STATUS/g, 'Available'));
    $('#tTaken tbody').append(tb.replace(/STATUS/g, 'Taken'));
    $('#output').append('END prepareTables()<br>');
  }
  function displayPlayers() {
    $('#output').append('displayPlayers(' + players.length + ')<br>');
    for (var pos in cntr) {
      $('#tAvailable' + pos + ' tbody').empty();
      cntr[pos]['Available']=0;
      $('#tMine' + pos + ' tbody').empty();
      cntr[pos]['Mine']=0;
      $('#tTaken' + pos + ' tbody').empty();
      cntr[pos]['Taken']=0;
    }
    $('#output').append('--displayPlayers()<br>');
    for (var row in players) {
      cntr[players[row].position][players[row].status]++;
      $('#t' + players[row].status + players[row].position + ' tbody').append(getTableRow(cntr[players[row].position][players[row].status], players[row], 0))
    }
    $('#output').append('END displayPlayers()<br>');
  }
  function doSearch(s) {
    $('#tSearchResults tbody').empty();
    if (event.keyCode == 13) {
      srchterm="";
      $('#srchbox').val(srchterm);
    } else {
      srchterm = s;
    }
    if (srchterm.length > 0) {
      var cnt = 0;
      for (var row in players) {
        if (players[row]['name'].toUpperCase().indexOf(srchterm.toUpperCase()) >= 0) {
          cnt++;
          $('#tSearchResults tbody').append(getTableRow(cnt, players[row], 1));
        }
      }
    }
  }
  function changeStatus(pr, s) {
    for (var row in players) {
      if (players[row]['posrk'] == pr) {
        $('#output').append('updaing ' + players[row]['name'] + '<br>')
        var os = players[row]['status'];
        players[row]['status'] = s;
        $('#tdLastAction5').html($('#tdLastAction4').html());
        $('#tdLastAction4').html($('#tdLastAction3').html());
        $('#tdLastAction3').html($('#tdLastAction2').html());
        $('#tdLastAction2').html($('#tdLastAction1').html());
        $('#tdLastAction1').html('<table>' + getTableRow(1, players[row], 1) + '</table>');
      }
    }
    setTimeout(function() {
      displayPlayers();
    },500);
    $('#srchbox').val('');
    doSearch('');
    $('#srchbox').focus();
  }
  function updateStatus(pr, s) {
    var ret = '';
  }
  function getTableRow(c, p, s) {
    var ret = '';
    var icn = '';
    icn += "<img src=\"../img/ICON\" ";
    icn += "height=\"15\" width=\"15\" ";
    icn += "onclick=\"changeStatus('" + p['posrk'] + "', 'STATUS')\">&nbsp;&nbsp;";
    if ( !(c%2)) { 
      ret += '<tr bgcolor="#d3d3d3"><td>'; 
    } else {
      ret += '<tr><td>'
    }
    if (p['status'] != "Mine") {
      ret += icn.replace('ICON','check.png').replace('STATUS','Mine');
    }
    if (p['status'] != "Taken") {
      ret += icn.replace('ICON','x.png').replace('STATUS','Taken');
    }
    if (p['status'] != "Available") {
      ret += icn.replace('ICON','clear.jpg').replace('STATUS','Available');
    }
    ret += ((s == 1) ? p.posrk : p.rank) + '&nbsp;' + p.name + '&nbsp;(<i>' + p.team + '</i>)</td></tr>';
    return ret;
  }
</script>
</head>
<body>
  <input type="file" name="rankcsv" id="rankcsv">
  <br><div id="fileStats"></div><hr>
  <input type="text" name="srchbox" id="srchbox" size=50>
  <br><br>
  <table id="tLastAction" border="1"><tr>
    <td id="tdLastAction1"></td>
    <td id="tdLastAction2"></td>
    <td id="tdLastAction3"></td>
    <td id="tdLastAction4"></td>
    <td id="tdLastAction5"></td>
  </tr></table>
  <hr>
  <b>SEARCH RESULTS</b>
  <table id="tSearchResults" border="1">
    <thead></thead>
    <tbody><tr>
    </tr></tbody>
  </table>
  <hr>
  <b>MY TEAM</b>
  <table id="tMine" border="1">
    <thead></thead>
    <tbody></tbody>
  </table>
  <hr>
  <b>AVAILABLE</b>
  <table id="tAvailable" border="1">
    <thead></thead>
    <tbody>
    </tbody>
  </table>
  <hr>
  <b>TAKEN</b>
  <table id="tTaken" border="1">
    <thead></thead>
    <tbody></tbody>
  </table>
  <hr><div id="output"></div>
</body>
</html>